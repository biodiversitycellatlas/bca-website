<!--
Species selector and tab navigation for Cell Atlas

When a species is selected, automatically redirects to species page
-->

<select id="species" class="mb-3" placeholder="Search species by name, taxonomic rank, division, ...">
    <option value=""></option>
    {% for phylum, species_list in species_dict.items %}
        <optgroup label="{{ phylum }}">
        {% for elem in species_list %}
            <option value="{{elem.species.species_underscore}}" data-meta="{{elem.meta|join:','}}" data-image="{{elem.species.image_url}}" {% if species == elem.species %}selected{%endif%}>{{ elem.species.scientific_name }}</option>
        {% endfor %}
        </optgroup>
    {% endfor %}
</select>

<!-- Species selection: selectize.js JavaScript options -->
<script>
$(function () {
    $("#species").selectize({
        // Jump to species page upon selection
        onChange: function(value) {
            // Avoid jumping if value is empty or matches current species
    	    if (value !== "" && value !== '{{species.species_underscore}}') {
    			window.location.replace(
    			    {% if request.resolver_match.view_name == 'atlas' %}
    			        "{% url 'atlas_info' '::arg' %}".replace('::arg', value)
    			    {% else %}
    			        "{% url request.resolver_match.view_name '::arg' %}".replace('::arg', value)
    			    {% endif %}
    			);
    		}
		},
		onDropdownOpen: function() {
		    this.clear();
		},
		onBlur: function() {
		    // Set current species if no value is selected
            if (!this.getValue()) {
                this.setValue('{{species.species_underscore}}');
            }
        },
		onType: function(str) {
		    $('.highlight').closest('.species-meta').css('display', 'inline-block');
		},
		render: {
            item: function (item, escape) {
                return `<div class='option'><img src="${item.image}" style="width: 20px;"> <i>${item.text}</i></div>`;
            },
            option: function (item, escape) {
                var meta_array = item.meta.split(',');
                badges = '';
                for(var i = 0; i < meta_array.length; i++) {
                    if (meta_array[i] !== '') {
                        span = '<span class="species-meta badge rounded-pill text-bg-secondary">';
                        badges += ` ${span}<small>${meta_array[i]}</small></span>`;
                    }
                }
                var img = item.image === "None" ? "" : item.image;
                return `<div class='option'><img src="${img}" style="width: 20px;"> <i>${item.text}</i>${badges}</div>`;
            }
        },
        searchField: ['text', 'meta', 'optgroup']
    });
});
</script>

<!-- Tabs to navigate the cell atlas of a given species -->
{% with request.resolver_match.url_name as url_name %}
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link {% if url_name in 'atlas,atlas_info' %}active{% endif %} {% if not species %}disabled{% endif %}" href="{% if species %}{% url 'atlas_info' species.species_underscore %}{% endif %}"><i class="fa fa-dna"></i> Information</a>
    </li>

    <li class="nav-item">
        <a class="nav-link {% if url_name == 'atlas_overview' %}active{% endif %} {% if not species %}disabled{% endif %}" href="{% if species %}{% url 'atlas_overview' species.species_underscore %}{% endif %}"><i class="fa fa-diagram-project"></i> Overview</a>
    </li>

    <li class="nav-item">
        <a class="nav-link {% if url_name == 'atlas_markers' %}active{% endif %} {% if not species %}disabled{% endif %}" href="{% if species %}{% url 'atlas_markers' species.species_underscore %}{% endif %}"><i class="fa fa-list-ul"></i> Metacell markers <i class="fa fa-circle-question" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Identify genes with specific expression patterns in selected metacells"></i></a>
    </li>

    <li class="nav-item">
        <a class="nav-link {% if url_name == 'atlas_gene' %}active{% endif %} {% if not species %}disabled{% endif %}" href="{% if species %}{% url 'atlas_gene' species.species_underscore %}{% endif %}"><i class="fa fa-bezier-curve"></i> Gene and orthologs <i class="fa fa-circle-question" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Visualise gene and ortholog expression"></i></a>
    </li>

    <li class="nav-item">
        <a class="nav-link {% if url_name == 'atlas_compare' %}active{% endif %} {% if not species %}disabled{% endif %}" href="{% if species %}{% url 'atlas_compare' species.species_underscore %}{% endif %}"><i class="fa fa-scale-unbalanced"></i> Species comparison <i class="fa fa-circle-question" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="Compare genes between cell types of different species"></i></a>
    </li>
</ul>

<!-- Set species in cookie -->
<!--{% if species %}
<script>document.cookie='species={{species}}';</script>
{% endif %}-->

{% endwith %}
