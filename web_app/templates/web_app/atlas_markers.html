{% extends "base.html" %}

{% block title %}{{species}} Markers{% endblock title %}

{% block content %}
{% include 'web_app/components/atlas_selection.html' %}
{% include 'web_app/components/warning_alert.html' %}

<div class="container">
    <div class="row">
        <div class="col-3">
            <form>
                <fieldset>
                    <legend class="h5">Cell selection</legend>
                    <div class="mb-3">
                        <label class="col-form-label" for="metacells">Metacells</label>
                        <select required name="metacells" value="" id="metacells" multiple placeholder="Select metacells...">
                            <option value=""></option>
                            {% for key, value in metacell_dict.items %}
                                <optgroup label="{{ key }}">
                                    {% if key == 'Cell types' %}
                                        {% for type, mc in value.items %}
                                            <option value="{{type}}" data-type="cell_types" data-metacells="{{mc|join:','}}" data-color="{{type.color}}">{{type}}</option>
                                        {% endfor %}
                                    {% elif key == 'Metacells' %}
                                        {% for mc in value %}
                                            <option value="{{mc.name}}" data-type="metacells" data-color="{{mc.color}}" data-celltype="{{mc.type}}">{{mc.name}}</option>
                                        {% endfor %}
                                    {% endif %}
                                </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                </fieldset>
                
                <fieldset>
                    <legend class="h5">Fold-change</legend>
                    <div class="mb-3">
                        <label class="col-form-label" for="fc_min_type">Min. fold-change <i class="fa fa-circle-question" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Minimum fold-change for gene filtering"></i></label>
                        <select class="form-select" name="fc_min_type" id="fc_min_type" aria-label="Select example" value="median">
                            <option value="mean" {% if query.fc_max_bg_type == 'mean' %}selected{% endif %}>Mean</option>
                            <option value="median" {% if query.fc_max_bg_type == 'median' %}selected{% endif %}>Median</option>
                        </select>
                    </div>

                    <input type="range" class="js-range-slider" id="fc_min" name="fc_min" value="{{query.fc_min|default:2}}" step="0.1">
                    <script>
                        $("#fc_min").ionRangeSlider({
                            min: 0,
                            max: 5,
                            from: {{query.fc_min|default:2}},
                            step: 0.1,
                            grid: false,
                            skin: "round"
                        });
                    </script>

                    <hr>
                    <div class="mb-3">
                        <label class="col-form-label" for="fc_max_bg_type">Max. fold-change (background) <i class="fa fa-circle-question" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Maximum fold-change in non-selected cells"></i></label>
                        <select class="form-select" id="fc_max_bg_type" name="fc_max_bg_type" aria-label="Select example" onchange="toggleMaxFCslider(this, '#fc_max_bg');">
                            <option value="ignore" {% if query.fc_max_bg_type == 'ignore' %}selected{% endif %}>Ignore</option>
                            <option value="mean" {% if query.fc_max_bg_type == 'mean' %}selected{% endif %}>Mean</option>
                            <option value="median" {% if query.fc_max_bg_type == 'median' %}selected{% endif %}>Median</option>
                        </select>
                    </div>

                    <input type="range" class="js-range-slider" id="fc_max_bg" name="fc_max_bg" value="{{query.fc_max_bg|default:3}}" step="0.1" disabled>
                    <script>
                        $("#fc_max_bg").ionRangeSlider({
                            min: 0,
                            max: 5,
                            from: {{query.fc_max_bg|default:3}},
                            step: 0.1,
                            grid: false,
                            skin: "round"
                        });

                        function toggleMaxFCslider(elem, id) {
                            var slider = $(id).data("ionRangeSlider");
                            var html   = slider["result"]["slider"];
                            if (elem.value == 'ignore') {
                                slider.update({ disable: true });
                            } else {
                                slider.update({ disable: false });
                            }
                        }

                        // Hide slider depending on value of #fc_max_bg_type
                        toggleMaxFCslider($('#fc_max_bg_type')[0], '#fc_max_bg')
                    </script>
                    <button type="submit" class="btn btn-primary my-3 w-100">List markers</button>
                </fieldset>
            </form>
        </div>
        <div class="col-9">
            {% if markers_table %}
                <div class="row g-0 float-end mb-3">
                    <div class="col-auto text-end text-muted form-control-sm">
                        Selected metacells: <span id="selected_metacells">None</span> <b>({{selected_metacells|length}} in total)</b>
                    </div>
                    <div class="col-auto">
                        {% include 'web_app/components/clipboard_button.html' %}
                    </div>
                </div>
                <table id="markers_table" class="display" style="width:100%"></table>
                <script>
                    // Round numeric values
                    function round (data, type, row) {
                        if (type === 'display' || type === 'filter') {
                            return parseFloat(data).toFixed(2);
                        }
                        return data;
                    }

                    // Improve array parsing
                    function parseArray (data, type, row) {
                        if (Array.isArray(data)) {
                            return data.join(', ');
                        }
                        return data;
                    }

                    // Create DataTable
                    var data = {{markers_table|safe}};
                    $('#markers_table').dataTable({
                        data: data,
                        scrollX: true,
                        columns: [
                            { data: 'name', title: "Gene ID" },
                            { data: 'description', title: "Name" },
                            { data: 'domains', title: "Domains", render: parseArray },
                            { data: 'fg_sum_umi', title: "Total UMIs", render: round },
                            { data: 'umi_perc', title: "UMI %", render: round },
                            { data: 'fg_mean_fc', title: "Mean FC", render: round },
                            { data: 'fg_median_fc', title: "Median FC", render: round }
                        ]
                    });
                </script>
            {% else %}
                {% include 'web_app/components/mockup_table.html' %}
            {% endif %}
        </div>
    </div>
</div>

<!-- Metacell: selectize.js JavaScript options -->
<script>
    function convertToRange(str) {
        // Sort numeric values
        const numbers = str.split(',').map(Number).sort((a, b) => a - b);
        let ranges = [];
        let start = numbers[0];
        let end = numbers[0];
        
        for (let i = 1; i < numbers.length; i++) {
            if (numbers[i] === end + 1) {
                end = numbers[i];
            } else {
                ranges.push(start === end ? `${start}` : `${start}-${end}`);
                start = numbers[i];
                end = numbers[i];
            }
        }
        
        // Add the last range
        ranges.push(start === end ? `${start}` : `${start}-${end}`);
        
        return ranges.join(',');
    }

    $(function () {
        $("#metacells").selectize({
            multiple: true,
            plugins: ['remove_button'],
            onInitialize: function() {
                var metacell_values = '{{ query.metacells }}'.split(',');
                this.setValue(metacell_values);
            },
            searchField: ['text', 'celltype'],
            render: {
                item: function (item, escape) {
                    var metacells;
                    var text;
                    var span_class = 'badge rounded-pill text-bg-secondary';
                    if (item.type == 'metacells') {
                        metacells = item.text;
                        text      = '';
                    } else {
                        metacells = item.metacells;
                        text      = item.text.replaceAll('_',' ');
                        span_class += ' ms-1';
                    }

                    var badge = '';
                    if (metacells) {
                        metacells = convertToRange(String(metacells));
                        badge = `<span class="${span_class}">${metacells}</span>`;
                    }
                    return `<div class='item'>${text}${badge}</div>`;
                },
                option: function (item, escape) {
                    var extra = '';
                    var text = item.text;
                    if (item.metacells) {
                        var metacells = convertToRange(String(item.metacells));
                        extra = `<br><small>Metacells: ${metacells}</small>`;
                    } else {
                        var type = item.celltype.replaceAll('_',' ');;
                        extra = `<br><small>Cell type: ${type}</small>`;
                    }
                    text = text.replaceAll('_',' ');
                    return `<div class='option'>${text}${extra}</div>`;
                }
            },
        });
    });
</script>

<!-- Simplify multiple select input into a single comma-separated value -->
<script>
    function updateMetacellSelectionText(selected) {
        var minimized = convertToRange(selected).replaceAll(',', ', ');

        underline = 'style="-webkit-text-decoration: underline dotted; text-decoration: underline dotted;"';
        tooltip   = `data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="${selected}"`;
        $('#selected_metacells').html(`<span ${underline} ${tooltip}>${minimized}</span>`);
    }
    updateMetacellSelectionText("{{selected_metacells|join:', '}}");

    $('form').on('submit', function(e) {
        e.preventDefault();
    
        var formData = new FormData(this);
        var values = formData.getAll('metacells').join(',');
        formData.set('metacells', values);
    
        var query = {};
        for (let [key, value] of formData.entries()) {
            query[key] = value;
        }
        // Convert query to URL parameters (but maintain commas)
        query = $.param(query).replaceAll('%2C', ',');
        window.location.href = '{{ request.path }}?' + query;
    })
</script>

{% endblock content %}