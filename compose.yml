services:
    nginx:
        image: nginx:1.29
        ports:
            - "${WEB_PORT:-8080}:80"
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
            # Media and static files
            - static_files:/static
            - ./data:/data
        depends_on:
            - ghost
            - web
        profiles: ["nginx"]

    ghost:
        image: ghost:6.4-alpine
        env_file: [.env]
        expose:
            - "2368"
        volumes:
            - ghost_data:/var/lib/ghost/content
            - ./ghost/default.hbs:/var/lib/ghost/content/themes/source/default.hbs
            - ./ghost/partials/announcement-bar.hbs:/var/lib/ghost/content/themes/source/partials/announcement-bar.hbs
            - ./ghost/partials/components/footer.hbs:/var/lib/ghost/content/themes/source/partials/components/footer.hbs
            - ./ghost/partials/components/post-list.hbs:/var/lib/ghost/content/themes/source/partials/components/post-list.hbs
            - ./ghost/partials/components/tracking.hbs:/var/lib/ghost/content/themes/source/partials/components/tracking.hbs
        environment:
            - url=${GHOST_URL}
            - database__client=${GHOST_DATABASE_CLIENT}
            - database__connection__filename=${GHOST_DATABASE_CONNECTION_FILENAME}
            - security__staffDeviceVerification=${GHOST_SECURITY_STAFFDEVICEVERIFICATION}
            - NODE_TLS_REJECT_UNAUTHORIZED=${GHOST_NODE_TLS_REJECT_UNAUTHORIZED}
            - mail__options__host=${GHOST_MAIL_OPTIONS_HOST}
            - mail__options__port=${GHOST_MAIL_OPTIONS_PORT}
            - mail__transport=${GHOST_MAIL_TRANSPORT}

    mailpit:
        image: axllent/mailpit:v1.28
        env_file: [.env]
        container_name: mailpit
        restart: unless-stopped
        ports:
            - "1025:1025" # SMTP
            - "8025:8025" # Web UI

    web:
        build: .
        # user: "${DOCKER_WEB_USER:-bca}"
        restart: always
        env_file: [.env]
        command: ["./entrypoint.sh"]
        ports:
            - 8000:8000
        volumes:
            - ./entrypoint.sh:/usr/src/app/entrypoint.sh
            # Update Django files in real-time
            - .:/usr/src/app
            # Media and static files
            - static_files:/usr/src/app/static
            - ./data:/usr/src/app/data
            # Postgres files
            - ./.pgpass:/postgres/.pgpass
            - ./.pg_service.conf:/postgres/.pg_service.conf
        environment:
            - PGPASSFILE=/postgres/.pgpass
            - PGSERVICEFILE=/postgres/.pg_service.conf

    db:
        image: postgres:18.1-trixie
        restart: always
        env_file: [.env]
        command: |
            postgres
                -c max_wal_size=2GB
                -c maintenance_work_mem=4GB
                -c work_mem=64MB
        volumes:
            - db_data:/var/lib/postgresql
            - ./docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
            - ./.pgpass:/postgres/.pgpass
            - ./.pg_service.conf:/postgres/.pg_service.conf
        environment:
            - PGPASSFILE=/postgres/.pgpass
            - PGSERVICEFILE=/postgres/.pg_service.conf
            - POSTGRES_DB=bca
            - POSTGRES_HOST=db
            - POSTGRES_HOST_AUTH_METHOD=trust
            - POSTGRES_PORT=5432
            - PGUSER=postgres
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=mypassword
        ports:
            - "${DB_PORT:-5432}:5432"
        profiles: ["db"]

volumes:
    db_data:
    static_files:
    ghost_data:
