---
name: Security scan

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    schedule:
        # Run every Wednesday at 7h
        - cron: "0 7 * * 3"
    workflow_dispatch:

permissions:
    contents: read

jobs:
    trivy:
        name: Docker security (Trivy)
        runs-on: ubuntu-latest

        permissions:
            security-events: write # upload SARIF results

        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  persist-credentials: false

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              run: docker build -t bca-website:ci .

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: bca-website:ci
                  format: "template"
                  template: "@/contrib/sarif.tpl"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v4
              with:
                  sarif_file: "trivy-results.sarif"

    bandit:
        name: Python security (Bandit)
        runs-on: ubuntu-latest

        permissions:
            security-events: write # upload SARIF results

        steps:
            - name: Run Bandit and upload results to GitHub Security tab
              uses: PyCQA/bandit-action@v1
              with:
                  exclude: ".git,./scripts,__pycache__"
