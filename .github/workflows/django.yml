name: Django CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    django-ci:
        name: Django Tests
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Copy .env file
          run: cp .env.template .env

        - name: Set up Docker Compose
          uses: docker/setup-compose-action@v1

        - name: Start services
          run: docker compose up -d --build

        - name: Install coverage
          run: docker compose exec web pip install coverage

        - name: Run tests with coverage
          run: docker compose exec web coverage run manage.py test

        - name: Show coverage report
          run: |
            docker compose exec web coverage report \
                --skip-covered --fail-under=80

        - name: Run deployment check
          run: docker compose exec web python manage.py check --deploy
