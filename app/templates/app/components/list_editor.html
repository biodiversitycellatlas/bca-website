{% comment %}

Edit gene lists via a modal

Input:
- id: prefix of element identifiers

{% endcomment %}

<div class="modal fade" id="{{id}}_editor" tabindex="-1"
data-bs-backdrop="static" data-bs-keyboard="false"
aria-labelledby="{{id}}_modal_label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h1 class="modal-title fs-5" id="{{id}}_editor_label">Gene lists</h1>
            <span class="ms-2 me-5">
                <img class="rounded" src="{{species.image_url}}" style="width: 25px;">
                <i class="small">{{species}}</i>
            </span>

            <div class="ms-auto d-flex align-items-center">
                {% include './data_button.html' with id=id %}
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-4">

                    <div id="{{id}}_options" class="list-group"
                    style="max-height: 500px; overflow-y: auto; margin-left: -1px; padding-right: 1px;">

                        <template id="{{id}}_element">
                            <a href="javascript:void(0);"
                            class="list-group-item list-group-item-action {{id}}_group_a"
                            data-bs-toggle="list" data-list="Transcription factors">
                                <span class="{{id}}_group_title">Transcription factors</span>
                                <div class="d-grid d-lg-flex w-100 justify-content-between">
                                    <small class="{{id}}_group_count text-muted">
                                        140 genes
                                    </small>
                                    <small class="{{id}}_group_type text-muted"
                                    style="font-variant: all-small-caps;">
                                        Preset <i class="fa fa-lock fa-fw"></i>
                                    </small>
                                </div>
                            </a>
                        </template>

                    </div>

                    <div class="btn-group mt-3 w-100" role="group">
                        <button type="button"
                        class="btn btn-outline-secondary btn-xs dropdown-toggle flat-right-border"
                        data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa fa-plus"></i> New
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="#">
                                <i class="fa-regular fa-circle fa-fw"></i>
                                Empty list
                            </a>
                            <a class="dropdown-item" href="#">
                                <i class="fa fa-list-ul fa-fw"></i>
                                List with selected 8 genes
                            </a>
                            <a class="dropdown-item" href="#">
                                <i class="fa fa-clone fa-fw"></i>
                                Duplicate from selected list
                            </a>
                            <a class="dropdown-item" href="#"
                            data-bs-toggle="tooltip" data-bs-placement="right"
                            data-bs-html="true" data-bs-container="body"
                            data-bs-custom-class="upload-tooltip"
                            data-bs-title="Comma- or tab-separated file with two columns:
                                    <ul class='text-start'>
                                        <li>Name of gene list</li>
                                        <li>Gene symbol (one per line)</li>
                                    </ul><hr><span>Example:</span>
                                    <table class='table table-sm table-dark table-hover my-1'>
                                        <tbody>
                                            <tr><td>Homeoboxes</td><td>PAX6</td></tr>
                                            <tr><td>Homeoboxes</td><td>HOXA1</td></tr>
                                            <tr><td>Myosins</td><td>MYH2</td></tr>
                                        </tbody>
                                    </table>">
                                <i class="fa fa-file-arrow-up fa-fw"></i>
                                Upload list
                            </a>

                            <!-- Boolean operations -->
                            <hr class="dropdown-divider">
                            <p class="text-muted small ps-3 mb-0">
                                Boolean operations
                            </p>

                            <a class="dropdown-item" href="#"
                            data-bs-toggle="tooltip" data-bs-placement="right"
                            data-bs-title="Create a new list with all genes from selected lists">
                                <i class="ph-duotone ph-unite"></i> Unite genes
                            </a>
                            <a class="dropdown-item" href="#"
                            data-bs-toggle="tooltip" data-bs-placement="right"
                            data-bs-title="Create a new list with intersecting genes from selected lists">
                                <i class="ph-duotone ph-intersect"></i> Intersect genes
                            </a>
                            <a class="dropdown-item" href="#"
                            data-bs-toggle="tooltip" data-bs-placement="right"
                            data-bs-title="Create a new list with non-intersecting genes from selected lists">
                                <i class="ph-duotone ph-exclude"></i> Exclude genes
                            </a>
                            <a class="dropdown-item" href="#"
                            data-bs-toggle="tooltip" data-bs-placement="right"
                            data-bs-title="Create a new list by subtracting genes from selected lists">
                                <i class="ph-duotone ph-subtract"></i> Subtract genes
                            </a>


                            <hr class="dropdown-divider">
                            <p class="text-muted small mb-0"
                            style="text-align: center;">
                                <i class="fa fa-shield-halved"></i>
                                Custom lists are stored<br>
                                <b>only</b> in your local browser.
                            </p>
                        </div>

                        <button type="button" class="btn btn-outline-danger btn-xs"
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                        data-bs-title="Remove custom gene lists for <i>{{species}}</i>">
                            <i class="fa fa-clock-rotate-left fa-fw"></i>
                            <span class="d-none d-lg-inline">Reset</span>
                        </button>
                    </div>
                </div>
                <div class="col-8">
                    <div class="row">
                        <div class="col">
                            <div class="input-group">
                                <input class="form-control"
                                id="{{id}}_editor_list_name"
                                value="Transcription factors">

                                <button class="btn btn-outline-secondary"
                                type="button">
                                    Rename
                                </button>
                            </div>
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-outline-danger"
                            data-bs-toggle="tooltip" data-bs-placement="top"
                            data-bs-title="Remove gene list">
                                <i class="fa fa-trash"></i>
                                <span class="d-none d-lg-inline">Remove</span>
                            </button>
                        </div>
                    </div>

                    <hr>
                    <table id="{{id}}_editor_table" class="display compact"
                    style="width:100%"></table>

                </div>
            </div>
        </div>
    </div>
  </div>
</div>

{% load static %}
<script>
    var gene_url = "{% url 'atlas_gene' species.species_underscore %}";
</script>
<script type="text/javascript" src="{% static 'app/js/list_editor_table.js' %}"></script>
<script>
$(function() {
    // Get lists from API
    var url = "{% url 'rest:genelist-list' %}";
    var params = new URLSearchParams({ species: '{{species}}' });
    var genelist_apiURL = url + "?" + params.toString();

    const template = document.getElementById('{{id}}_element');
    const container = document.getElementById('{{id}}_options');

    fetch(genelist_apiURL)
        .then(response => response.json())
        .then(data => {
            res = data.results;
            res.forEach(item =>{
                const clone = document.importNode(template.content, true);

                clone.querySelector('.{{id}}_group_a').setAttribute("data-list", item.name);
                clone.querySelector('.{{id}}_group_title').textContent = item.name;
                clone.querySelector('.{{id}}_group_count').textContent = `${item.gene_count} genes`;

                container.appendChild(clone);
            });
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });

    // Get data and render table for lists
    var url = "{% url 'rest:gene-list' %}";

    function getApiURL (genelist) {
        var params = new URLSearchParams({
    	    species: '{{species}}',
    	    genelists: genelist
    	});
    	return url + "?" + params.toString();
    }

    var list = $("#{{id}}_options").find(".active").attr('data-list');
    createListEditorTable('{{id}}_editor_table', getApiURL(list));

    $("#{{id}}_options").on('click', '.active', function(event) {
        // Prevent event triggering if already active
        //if ($(this).hasClass('active')) {
        //    event.preventDefault();
        //    return;
        //}

        var list = $(this).attr('data-list');
        apiURL = getApiURL(list);

        var table = $('#{{id}}_editor_table').DataTable();
        table.search('').columns().search(''); // Clear search
        table.clear(); // Clear data
        table.ajax.url(apiURL).load();

        $('#{{id}}_editor_list_name').val(list);
    });
});
</script>
