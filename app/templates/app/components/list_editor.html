{% comment %}

Edit gene lists via a modal

Input:
- id: prefix of element identifiers
- type: 'gene_lists'

{% endcomment %}

<div class="modal fade" id="{{id}}_{{type}}_editor" tabindex="-1"
data-bs-backdrop="static" data-bs-keyboard="false"
aria-labelledby="{{id}}_{{type}}_modal_label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h1 class="modal-title fs-5" id="{{id}}_{{type}}_editor_label">Gene lists</h1>
            <span class="ms-2 me-5">
                <img class="rounded" src="{{species.image_url}}" style="width: 25px;">
                <i class="small">{{species}}</i>
            </span>

            <div class="ms-auto d-flex align-items-center">
                {% include './data_button.html' with id=id %}
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-4">

                    <div id="{{id}}_{{type}}_options" class="list-group"
                    style="max-height: 500px; overflow-y: auto; margin-left: -1px; padding-right: 1px;">

                        <template id="{{id}}_{{type}}_element">
                            <a href="javascript:void(0);"
                            class="list-group-item list-group-item-action {{id}}_{{type}}_group_a"
                            data-bs-toggle="list">
                                <i class="fa fa-circle color-bullet {{id}}_{{type}}_group_bullet"></i>
                                <span class="{{id}}_{{type}}_group_title"></span>
                                <div class="d-grid d-lg-flex w-100 justify-content-between">
                                    <span class="{{id}}_{{type}}_group_count text-body-secondary small">
                                        140 genes
                                    </span>
                                    <span class="{{id}}_{{type}}_group_group text-body-secondary"
                                    style="font-variant: small-caps;
                                    text-transform: lowercase;
                                    margin-bottom: -5px;">
                                        Preset <i class="fa fa-lock fa-xs fa-fw"></i>
                                    </span>
                                </div>
                            </a>
                        </template>

                    </div>

                    <div class="btn-group mt-3 w-100" role="group">
                        <button type="button"
                        class="btn btn-outline-secondary btn-xs dropdown-toggle flat-right-border"
                        data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa fa-plus"></i> New
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="javascript:void(0);"
                            id="{{id}}_{{type}}_new_empty">
                                <i class="fa-regular fa-circle fa-fw"></i>
                                Empty list
                            </a>
                            <a class="dropdown-item disabled"
                            href="javascript:void(0);"
                            id="{{id}}_{{type}}_new_selected">
                                <i class="fa fa-list-ul fa-fw"></i>
                                List with selected
                                <span id="{{id}}_{{type}}_new_selected_count">
                                    0 genes
                                </span>
                            </a>
                            <a class="dropdown-item" href="javascript:void(0);"
                            id="{{id}}_{{type}}_new_duplicate">
                                <i class="fa fa-clone fa-fw"></i>
                                Duplicate from selected list
                            </a>
                            <a class="dropdown-item" href="javascript:void(0);"
                            onclick="document.getElementById('{{id}}_{{type}}_new_upload').click();"
                            data-bs-toggle="tooltip" data-bs-placement="right"
                            data-bs-html="true" data-bs-container="body"
                            data-bs-custom-class="upload-tooltip"
                            data-bs-title="Comma- or tab-separated file<br>with four columns:
                                    <ul class='text-start'>
                                        <li>Group of gene list</li>
                                        <li>Name of gene list</li>
                                        <li>Colour of gene list (HEX/RGB code or colour name)</li>
                                        <li>Gene symbol (one per line)</li>
                                    </ul>
                                    <i class='fa fa-triangle-exclamation'></i>
                                    Lines starting with <code>#</code> are ignored.
                                    <hr><span>Example:</span>
                                    <table class='table table-sm table-dark table-hover my-1'>
                                        <tbody>
                                            <tr>
                                                <td>Custom</td>
                                                <td>Homeoboxes</td>
                                                <td>#ff6eb0</td>
                                                <td>PAX6</td></tr>
                                            <tr>
                                                <td>Custom</td>
                                                <td>Homeoboxes</td>
                                                <td>#ff6eb0</td>
                                                <td>HOXA1</td></tr>
                                            <tr>
                                                <td>Custom</td>
                                                <td>Myosins</td>
                                                <td>red</td>
                                                <td>MYH2</td></tr>
                                        </tbody>
                                    </table>">
                                <i class="fa fa-file-arrow-up fa-fw"></i>
                                Upload lists

                                <input id="{{id}}_{{type}}_new_upload"
                                type="file"
                                class="form-control form-control-sm d-none">
                            </a>

                            {% comment %}
                            <!-- Boolean operations -->
                            <hr class="dropdown-divider">
                            <p class="text-body-secondary small ps-3 mb-0">
                                Boolean operations
                            </p>

                            <a class="dropdown-item" href="javascript:void(0);"
                            data-bs-toggle="tooltip" data-bs-placement="right"
                            data-bs-title="Create a new list with all genes from selected lists">
                                <i class="ph-duotone ph-unite"></i> Unite genes
                            </a>
                            <a class="dropdown-item" href="javascript:void(0);"
                            data-bs-toggle="tooltip" data-bs-placement="right"
                            data-bs-title="Create a new list with intersecting genes from selected lists">
                                <i class="ph-duotone ph-intersect"></i> Intersect genes
                            </a>
                            <a class="dropdown-item" href="javascript:void(0);"
                            data-bs-toggle="tooltip" data-bs-placement="right"
                            data-bs-title="Create a new list with non-intersecting genes from selected lists">
                                <i class="ph-duotone ph-exclude"></i> Exclude genes
                            </a>
                            <a class="dropdown-item" href="javascript:void(0);"
                            data-bs-toggle="tooltip" data-bs-placement="right"
                            data-bs-title="Create a new list by subtracting genes from selected lists">
                                <i class="ph-duotone ph-subtract"></i> Subtract genes
                            </a>
                            {% endcomment %}

                            <hr class="dropdown-divider">
                            <p class="text-body-secondary small mb-0"
                            style="text-align: center;">
                                <i class="fa fa-shield-halved"></i>
                                Custom lists are stored<br>
                                <b>only</b> in your local browser
                            </p>
                        </div>

                        <button id="{{id}}_{{type}}_reset"
                        type="button" class="btn btn-outline-danger btn-xs"
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                        data-bs-title="Remove custom gene lists for <i>{{species}}</i>">
                            <i class="fa fa-clock-rotate-left fa-fw"></i>
                            <span class="d-none d-lg-inline">Reset</span>
                        </button>
                    </div>
                </div>
                <div class="col-8">
                    <fieldset id="{{id}}_{{type}}_controls">
                        <div class="row">
                            <div class="col">
                                <div class="input-group">
                                    <input class="form-control"
                                    id="{{id}}_{{type}}_rename" value="">

                                    <button id="{{id}}_{{type}}_rename_btn"
                                    type="button"
                                    class="btn btn-outline-secondary">
                                        Rename
                                    </button>
                                </div>
                            </div>
                            <div class="col-auto">
                                <button id="{{id}}_{{type}}_remove"
                                type="button" class="btn btn-outline-danger"
                                data-bs-toggle="tooltip" data-bs-placement="top"
                                data-bs-title="Remove gene list">
                                    <i class="fa fa-trash"></i>
                                    <span class="d-none d-lg-inline">Remove</span>
                                </button>
                            </div>
                        </div>
                    </fieldset>

                    <hr>
                    <table id="{{id}}_{{type}}_editor_table"
                    class="display compact"
                    style="width:100%"></table>

                </div>
            </div>
        </div>
    </div>
  </div>
</div>

{% load static %}
<script>
    var gene_url = "{% url 'atlas_gene' species.species_underscore %}";
</script>
<script type="text/javascript" src="{% static 'app/js/list_editor.js' %}"></script>
<script type="text/javascript" src="{% static 'app/js/list_editor_table.js' %}"></script>
<script>

$(function() {
    // Get lists from API
    var url = "{% url 'rest:genelist-list' %}";
    var params = new URLSearchParams({ species: '{{species}}' });
    var genelist_apiURL = url + "?" + params.toString();

    fetch(genelist_apiURL)
        .then(response => response.json())
        .then(data => {
            const res = data.results;

            // Append user lists
            var lists = getUserLists('{{id}}_{{type}}', '{{species}}');
            for (const index in lists) {
                const elem = lists[index];
                res.push({
                    name: elem.name,
                    gene_count: elem.items.length,
                    type: elem.group
                });
            }
            return res;
        })
        .then(data => {
            data.forEach((item, index) => {
                appendListGroupItem('{{id}}_{{type}}', item.name, item.type,
                                    item.gene_count,
                                    active=index === 0, firstRender=true);
            });
        })
        .then(data => {
            // Create table
            createListEditorTable('{{id}}_{{type}}_editor_table');
            renderListDetail('{{id}}_{{type}}', '{{species}}', "{% url 'rest:gene-list' %}");

            // Update interface based on selection
            var table = $('#{{id}}_{{type}}_editor_table').DataTable();
            table.on('select deselect', function(e, dt, type, indexes) {
                if (type === 'row') {
                    const len = getSelectedRows('{{id}}_{{type}}_editor_table').length;
                    var label = len + (len === 1 ? ' gene' : ' genes');
                    $('#{{id}}_{{type}}_new_selected_count').text(label);

                    // Disable element if no rows are selected
                    if (len === 0) {
                        $('#{{id}}_{{type}}_new_selected').addClass('disabled');
                    } else {
                        $('#{{id}}_{{type}}_new_selected').removeClass('disabled');
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });

    // Get data and render table for active group list
    let previousActiveList = null;

    // Trigger data rendering on any change to .active class
    $("#{{id}}_{{type}}_options").on('click keyup', '.active', function (event) {
        // Prevent event triggering if element was previously active
        if ( previousActiveList && previousActiveList.is($(this)) ) {
            event.preventDefault();
            return;
        }
        previousActiveList = $(this);
        renderListDetail('{{id}}_{{type}}', '{{species}}', "{% url 'rest:gene-list' %}");
    });

    // Menu actions: New
    $('#{{id}}_{{type}}_new_empty').on('click', function(e) {
        appendUserList('{{id}}_{{type}}', '{{species}}', 'Empty list', []);
    });

    $('#{{id}}_{{type}}_new_selected').on('click', function(e) {
        const selected = getSelectedRows('{{id}}_{{type}}_editor_table');
        appendUserList('{{id}}_{{type}}', '{{species}}', 'Selected genes', selected);
    });

    // Menu actions: Reset
    $('#{{id}}_{{type}}_reset').on('click', function(e) {
        if (confirm("Do you want to reset all custom gene lists for {{species}}?")) {
            resetUserLists('{{id}}_{{type}}', '{{species}}');
            redrawUserLists('{{id}}_{{type}}', '{{species}}');

            // Select the first item in the list if no element is selected
            if ($("#{{id}}_{{type}}_options").find('a.active').length === 0) {
                $("#{{id}}_{{type}}_options a").first().addClass('active').click();
            }
        }
    });

    // Menu actions: Rename and remove
    $('#{{id}}_{{type}}_rename_btn').on('click', function(e) {
        var renameInput = $('#{{id}}_{{type}}_rename');
        var newName = renameInput.val().trim();

        var activeItem = $("#{{id}}_{{type}}_options").find('a.active');
        var name = activeItem.find('.{{id}}_{{type}}_group_title').text();

        var all_names = $("#{{id}}_{{type}}_options").find('a .{{id}}_{{type}}_group_title')
            .map((i, el) => $(el).text()).get();

        if (newName === '') {
            // Avoid empty list name
            renameInput.val(name);
            alert('The name of a list cannot be empty.');
        } else if (all_names.includes(newName)) {
            // Avoid duplicated name
            alert('This list name is already in use.');
        } else {
            renameUserList('{{id}}_{{type}}', '{{species}}', name, newName);
            redrawUserLists('{{id}}_{{type}}', '{{species}}', activeList=[newName]);
        }
    });

    $('#{{id}}_{{type}}_remove').on('click', function(e) {
        var activeItem = $("#{{id}}_{{type}}_options").find('a.active');
        var name = activeItem.find('.{{id}}_{{type}}_group_title').text();

        if (confirm(`Do you want to remove the following list: ${name}?`)) {
            removeUserList('{{id}}_{{type}}', '{{species}}', name);
            redrawUserLists('{{id}}_{{type}}', '{{species}}');

            // Select the first item in the list if no element is selected
            if ($("#{{id}}_{{type}}_options").find('a.active').length === 0) {
                $("#{{id}}_{{type}}_options a").first().addClass('active').click();
            }
        }
    });

    $('#{{id}}_{{type}}_new_duplicate').on('click', function(e) {
        var activeItem = $("#{{id}}_{{type}}_options").find('a.active');
        var name = activeItem.data('list');
        var group = activeItem.data('group');

        var url = "{% url 'rest:gene-list' %}";
        fetchAllGenesFromList('{{id}}_{{type}}', '{{species}}', url, name, group)
            .then(genes => {
                appendUserList('{{id}}_{{type}}', '{{species}}', name, genes);
            })
            .catch(error => {
                console.error("Error fetching genes:", error);
            });
    });

    $("#{{id}}_{{type}}_new_upload").on("change", function () {
        createUserListsFromFile (this, '{{id}}_{{type}}', '{{species}}')
    });
});
</script>
